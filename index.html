<!DOCTYPE html>
<html>
  <head>
    <!-- ORDER IS IMPORTANT. THESE MUST ALWAYS COME FIRST, IN THIS ORDER -->
    <script src="./js/p5/p5.js"></script>
    <script src="./js/circumplex.js"></script>
    <script src="./js/bkk.js"></script>

    <!-- Now the JsPsych specific stuff -->
    <script src="./js/jquery.min.js"></script>
    <script src="./js/jspsych/jspsych.js"></script>
    <script src="./js/jspsych/plugin-instructions.js"></script>    
    <script src="./js/jspsych/plugin-html-button-response.js"></script>
    <script src="./js/jspsych/plugin-survey-text.js"></script>
    <script src="./js/bkk-plugins/bkk-survey-text.js"></script>


    <link rel="stylesheet" href="./js/jspsych/jspsych.css"></link>
    <link rel="stylesheet" href="./js/bkk.css"></link>

    <!-- OTHER FILES YOU MIGHT WANT TO EDIT -->
    <script src="js/consent_etc.js"></script> <!-- defines the consent page and the demographic checks -->


  </head>
  <body></body>
  <script>
    // Stops the user pressing "back" which would wipe all data
      function preventNavBack(){
        history.pushState(null, null, document.URL);
        window.addEventListener('popstate', function () {
            history.pushState(null, null, document.URL);
            window.alert("the back button has been disabled for the duration of the experiment, as using the back button will break the experiment");
        });
      }
      preventNavBack();


      function randomString(){
        return (Math.random() + 1).toString(36).substring(7);
      }


    var timeline=[];


    var jsPsych = initJsPsych({
      // HANDLE THE DATA AT THE END OF THE TRIAL
      on_finish: function() {

          // capture info from Prolific
        var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
        var study_id = jsPsych.data.getURLVariable('STUDY_ID');
        var session_id = jsPsych.data.getURLVariable('SESSION_ID');

        if (typeof subject_id == 'undefined'){ 
          subject_id = "nonProlific_" +randomString()
          study_id = "nonProlific"
          session_id = "session_id"
        }


        var interaction_data = jsPsych.data.getInteractionData();
        var clicksAway = 0;
        var exitFullscreen = false;
        for(const id of interaction_data.trials){
          if(id["event"]=="blur"){
            clicksAway+=1;
          }
          if(id["event"]=="fullscreenexit"){
            exitFullscreen = true;
          }          
        }

        var demogdata = jsPsych.data.get()
              .filter({easyName: 'demographics'})
              .values()["0"]["response"];

        var age = demogdata["Q0"];
        var gender = demogdata["Q1"];
        var country = demogdata["Q1"];


        if (typeof age == 'undefined'){ age = "not given"}
        if (typeof gender == 'undefined'){ gender = "not given"}
        if (typeof country == 'undefined'){ country = "not given"}                  
        
        var training_data = jsPsych.data.get().filter({trialCategory: 'training'});
        //  CAPTURE ANY INFO WE NEED TO KNOW ABOUT TRAINING


        jsPsych.data.addProperties({
          subject_id: subject_id,
          study_id: study_id,
          session_id: session_id,
          interaction_clicksAway: clicksAway,
          interaction_exitFullscreen: exitFullscreen,
          age: age,
          gender: gender,
          country: country
        });

        var bkk_data = jsPsych.data.get().filter({trialCategory: 'bkk stimulus'});

        // bkk_data.localSave('csv', jsPsych.randomization.randomID(32) + '.csv')
        jsPsych.data.displayData();

        var postdata = bkk_data.json()

        $.post('submit',{"content": postdata})

        // Handle redirect back to prolific
        // setTimeout(callback,1000)
      }
    });




//  SET TESTING MODE - REMOVES INTRO AND TIMING LIMITATIONS ----------------------------------------------
    var testing = true;
    var excludeIntro = true;    

    // THESE VALUES ARE MODIFIED BY TURNING TESTING ON
    var trial_time_lower_limit = 10 * 1000  // how long you have to stay on each BKK page
    var force_circumplex_click = true;      // if true you have to click the circumplex before continuing

    if(testing){
      trial_time_lower_limit = 0;
      force_circumplex_click = false;

    }


//  INTRODUCTION, Consent, Demographics -------------------------------------------------------------------


    // THESE PAGES ARE DEFINED IN CONSENT_ETC.JS
    var infoBlock = {
      timeline: [startPage, consent_page],
    }

    //  COMMENT OUT THIS LINE FOR TESTING IF YOU WANT - IT WILL GET RID OF THE INTRO, CONSENT, and Demographics pages
    if(!excludeIntro){
      timeline.push(infoBlock)
    }

    timeline.push(demog_page)




//  TRAINING  -----------------------------------------------------------------------------


    trainingTimeline = []


    var training1 = { type: jsPsychBKKSurveyText, 
        preamble: '<h1>Training Section</h1><p>In the experiment you will be shown various shapes and asked to record your emotional response to the shape.</p>' +
                  '<p>To record your emotional response you will click on a graph like this. The top of the graph represents high energy feelings. The bottom of the graph represents low energy feelings. The left side represents negative feelings, and the right side represents positive feelings.</p>'+
                  '<p>You can click anywhere on the graph if that represents your feelings. If the image you are shown represents a very energetic feeling for you, you should click right at the top of the graph. If it feels neither high energy nor low energy you can click somewhere close to the middle.</p>' +
                  '<p>Blah blah blah, Feng can explain it better I think.</p>' +
                  '<p>Click anywhere on the graph and then click submit to continue.</p>' +
                  '<br>', 
        // For testing you can turn this off so you don't need to click the cirucmplex each time
        circClick_required: true, 
        //  For testing set this to zero so you don't need to wait
        min_duration: trial_time_lower_limit,
        circ_hide: false, // hides the circumplex if true
        draw_bkk: false, // HIDING BKK FOR THESE INTRODUCITON TRIALS
        gui_show:false, 
        questions: [],
        data: {trialCategory: "training"}
      } 
      trainingTimeline.push(training1)



    var training2 = { type: jsPsychBKKSurveyText, 
        data: {trialCategory: "training"},
        preamble: '<center><img src="./img/happy_excited.jpg"></img></center><p> This image is of someone happy and excited. These kinds of emotions belong in the top right corner of the graph. They are very high energy (top), and very positive (right). Click close to the top right corner of the graph, and then click submit.</p>', 
        // For testing you can turn this off so you don't need to click the cirucmplex each time
        circClick_required: true, 
        //  For testing set this to zero so you don't need to wait
        min_duration: trial_time_lower_limit,
        circ_hide: false,
        draw_bkk: false, // HIDING BKK FOR THESE INTRODUCITON TRIALS
        gui_show:false, 
        questions: [],
        data: {trialCategory: "training"}
      } 
      trainingTimeline.push(training2)




    var training3 = { type: jsPsychBKKSurveyText, 
        data: {trialCategory: "training"},
        preamble: '<center><img src="./img/sad.jpg"></img></center><p> This image is of someone very sad and down. These kinds of emotions belong in the bottom left corner of the graph. They are very low energy (top), and very negative (right). Click close to the bottom left corner of the graph, and then click submit.</p>', 
        // For testing you can turn this off so you don't need to click the cirucmplex each time
        circClick_required: true, 
        //  For testing set this to zero so you don't need to wait
        min_duration: trial_time_lower_limit,
        circ_hide: false,
        draw_bkk: false, // HIDING BKK FOR THESE INTRODUCITON TRIALS
        gui_show:false, 
        questions: [],
        data: {trialCategory: "training"}
      } 
      trainingTimeline.push(training3)










    var finishTraining = {
        type: jsPsychHtmlButtonResponse,
        data: {trialCategory: "training"},
        stimulus: '<p>Great, you have completed the training section of the study. You will now begin the experiment.</p>'+
                  '<p>You will be shown 24 different shapes. For each shape click on the graph to record the emotion you think it represents. There are no right answers BLAH BLAH BLAH</p>' +
                  '<p>You will not be able to click onto the next shape until [10 seconds?] have passed. Please take at least this amount of time to reflect on each shape before recording the emotion you think it represents, and continuing.</p>' +
                  '<br>', 
        choices: ["continue"]
    }
    trainingTimeline.push(finishTraining)


    var trainingBlock = {
      timeline: trainingTimeline,
    }


    if(!excludeIntro){
      timeline.push(trainingBlock)
    }

//  EXPERIMENT  -----------------------------------------------------------------------------




//  BKK STIMULI 

    //  SET THE EXPERIMENT VARIABLES HERE
    //  Experiment Parameters (all are 0-255)
    //  you can try out values for parameters using try_out_parameters.html
    let roundVals = [24, 250] // spikiness or roundness of the BKK [variable name: slider_smooth]
    let countVals = [79, 225] // number of spikes [variable name: slider_complexity]
    let noiseVals = [0, 150] // how regular is the BKK (higher = less regular) [variable name: slider_noise]
    let lengthVals = [120, 250] // length of the protrusions [variable name: slider_spike]
    let showEyesVals = [false] // false = hide eyes, true = show eyes
    let drawOutline = true; // true = draw black outline around the shape


    let BKK_stim_variables = []
    for(let rnd of roundVals) {
      for(let cnt of countVals){
        for (let ns of noiseVals){
          for (let ey of showEyesVals){
            for (let lng of lengthVals){
              console.log(ey)
              let thisTrial = { eyes: ey, 
                                complexity: cnt, 
                                noise: ns,
                                smooth: rnd,
                                length: lng
                              }
              BKK_stim_variables.push(thisTrial)
            }
          }
        }
      }
    }
    console.log(BKK_stim_variables)


    var bkk_instruction = 'Look at the image below. How does it make you feel? Mark your feeling on the graph below, then click continue.'

    var bkk_stimulus = { type: jsPsychBKKSurveyText, 
      data: {trialCategory: "bkk stimulus"},
      bkkColor:'#D9D9D9', 
      spike: jsPsych.timelineVariable('length'),
      complexity: jsPsych.timelineVariable('complexity'), 
      noise: jsPsych.timelineVariable('noise'), 
      smooth: jsPsych.timelineVariable('smooth'), 
      draw_eyes: jsPsych.timelineVariable('eyes'),
      draw_outline: drawOutline,
      preamble: bkk_instruction, 

      gui_show: false, 
      // For testing you can turn this off so you don't need to click the cirucmplex each time
      circClick_required: force_circumplex_click, 

      min_duration: (trial_time_lower_limit), 
      circ_hide: false,
      draw_bkk: true,
      questions: []
    } 

    var bkk_sequence = {
    timeline: [bkk_stimulus],
    randomize_order: true,
    timeline_variables: BKK_stim_variables
    }

    timeline.push(bkk_sequence);    

//  END  -----------------------------------------------------------------------------

    timeline.push(debrief_page)


    jsPsych.run(timeline);


</script>

</html>